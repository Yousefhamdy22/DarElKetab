<div class="bg-gradient-to-b from-gray-50 to-white min-h-screen p-4 md:p-6" dir="rtl">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">إدارة المجموعات</h1>
        <p class="text-gray-600 mt-1">عرض وإدارة مجموعات الطلاب في المركز</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
        <button pButton icon="pi pi-home" label="الصفحة الرئيسية" 
                (click)="goToHome()" 
                class="p-button-secondary bg-gray-600 hover:bg-gray-700 border-gray-600 shadow-sm hover:shadow transition-all duration-200">
        </button>
        <button pButton icon="pi pi-plus" label="إضافة مجموعة" 
                (click)="showAddGroupForm()" 
                class="p-button-primary bg-emerald-600 hover:bg-emerald-700 border-emerald-600 shadow-sm hover:shadow transition-all duration-200">
        </button>
      </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-300 border-r-4 border-emerald-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">إجمالي المجموعات</p>
            <h3 class="text-2xl font-bold text-gray-800">{{ groups.length }}</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center">
            <i class="pi pi-users text-xl text-emerald-600"></i>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-300 border-r-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">إجمالي الطلاب</p>
            <h3 class="text-2xl font-bold text-gray-800">{{ getTotalStudents() }}</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
            <i class="pi pi-user text-xl text-blue-600"></i>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-300 border-r-4 border-amber-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">المجموعات النشطة</p>
            <h3 class="text-2xl font-bold text-gray-800">{{ getActiveGroupsCount() }}</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center">
            <i class="pi pi-check-circle text-xl text-amber-600"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm p-5 mb-6 transition-all duration-300 hover:shadow-md border border-gray-100">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="pi pi-filter text-emerald-600"></i>
        تصفية المجموعات
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="relative">
          <span class="p-float-label">
            <input pInputText id="search" type="text" class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring focus:ring-emerald-200 transition-all" 
                   [(ngModel)]="searchText" (input)="applyFilters()" />
            <label for="search" class="text-gray-500">بحث بالاسم</label>
          </span>
          <i class="pi pi-search absolute left-3 top-2.5 text-gray-400"></i>
        </div>
        <div>
          <p-dropdown [options]="statusOptions" [(ngModel)]="selectedStatus" 
                     optionLabel="label" (onChange)="applyFilters()"
                     placeholder="الحالة" [showClear]="true"
                     styleClass="w-full rounded-lg"></p-dropdown>
        </div>
        <div>
          <button pButton icon="pi pi-filter" label="تصفية" 
                  class="w-full bg-emerald-600 hover:bg-emerald-700 border-emerald-600 transition-all duration-200 shadow-sm hover:shadow"
                  (click)="applyFilters()"></button>
        </div>
      </div>
    </div>

    <!-- Groups Grid -->
     
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"   

       
 
    >
      <div *ngFor="let group of filteredGroups" 
      class="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden border border-gray-100"
      [routerLink]="'/group/details/' + group.groupID">
        <!-- Group Header -->
        <div class="p-4 border-b relative">
          <div class="absolute top-4 left-4">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                  [ngClass]="{
                    'bg-green-100 text-green-800': group.active,
                    'bg-red-100 text-red-800': !group.active
                  }">
              {{ group.active ? 'نشطة' : 'غير نشطة' }}
            </span>
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-1">{{ group.groupName }}</h3>
          <p class="text-sm text-gray-500">{{ group.description }}</p>
        </div>
        
        <!-- Group Details -->
        <div class="p-4">
          <!-- Teacher -->
          <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0">
              <i class="pi pi-user text-emerald-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">المعلم</p>
              <p class="font-medium text-gray-800">{{ group.teacher?.name || 'غير محدد' }}</p>
            </div>
          </div>
          
          <!-- Schedule -->
          <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
              <i class="pi pi-calendar text-blue-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">الجدول</p>
              <p class="font-medium text-gray-800">{{ group.scheduleDay }}</p>
            </div>
          </div>

          <!-- Education Stage & Grade -->
          <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0">
              <i class="pi pi-graduation-cap text-purple-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">المرحلة والصف</p>
              <p class="font-medium text-gray-800">{{ group.stage }} - الصف {{ group.stageLevel }}</p>
            </div>
          </div>
          
          <!-- Students -->
          <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
              <i class="pi pi-users text-amber-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">الطلاب</p>
              <div class="flex items-center gap-2">
                <p class="font-medium text-gray-800">{{ group.currentStudents || 0 }} / {{ group.maxStudentNumber || 0 }}</p>
                <div class="w-24 h-2 bg-gray-200 rounded-full">
                  <div class="h-2 rounded-full" 
                       [ngClass]="{
                         'bg-emerald-500': group.currentStudents && group.maxStudentNumber && (group.currentStudents / group.maxStudentNumber < 0.8),
                         'bg-amber-500': group.currentStudents && group.maxStudentNumber && (group.currentStudents / group.maxStudentNumber >= 0.8 && group.currentStudents < group.maxStudentNumber),
                         'bg-red-500': group.currentStudents && group.maxStudentNumber && (group.currentStudents >= group.maxStudentNumber)
                       }"
                       [style.width]="(group.currentStudents && group.maxStudentNumber ? (group.currentStudents / group.maxStudentNumber * 100) : 0) + '%'"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Start Date -->
          <!-- <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
              <i class="pi pi-calendar-plus text-indigo-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">تاريخ البداية</p>
              <p class="font-medium text-gray-800">{{ group | date:'dd/MM/yyyy' }}</p>
            </div>
          </div> -->
        </div>
        
        <!-- Actions -->
        <div class="bg-gray-50 p-3 flex justify-between items-center">
          <button pButton icon="pi pi-users" label="الطلاب" 
                  (click)="navigateToGroupDetails(group.groupID.toString())" 
                  class="p-button-text text-gray-700 text-xs"></button>
          <div class="flex gap-1">
            <button pButton icon="pi pi-pencil" pTooltip="تعديل" tooltipPosition="top"
                    (click)="showEditGroupForm(group)"
                    class="p-button-rounded p-button-text text-amber-600 hover:bg-amber-50 transition-colors"></button>
            <button pButton icon="pi pi-trash" pTooltip="حذف" tooltipPosition="top"
                    (click)="deleteGroup(group.groupID.toString())"
                    class="p-button-rounded p-button-text text-red-600 hover:bg-red-50 transition-colors"></button>
          </div>
        </div>
      
        <!-- <div class="bg-gray-50 p-3 flex justify-between items-center">
          <button pButton icon="pi pi-users" label="الطلاب" 
         
                  class="p-button-text text-gray-700 text-xs"></button>
          <div class="flex gap-1">
            <button pButton icon="pi pi-pencil" pTooltip="تعديل" tooltipPosition="top"
                    (click)="showEditGroupForm(group)"
                    class="p-button-rounded p-button-text text-amber-600 hover:bg-amber-50 transition-colors"></button>
            <button pButton icon="pi pi-trash" pTooltip="حذف" tooltipPosition="top"
                    (click)="deleteGroup(group.groupID.toString())"
                    class="p-button-rounded p-button-text text-red-600 hover:bg-red-50 transition-colors"></button>
          </div>
        </div> -->
      </div>
      
      <!-- Empty State -->
      <div *ngIf="filteredGroups.length === 0" class="col-span-full">
        <div class="bg-white rounded-xl shadow-sm p-8 text-center">
          <div class="flex flex-col items-center justify-center gap-3">
            <i class="pi pi-search text-4xl text-gray-300"></i>
            <span class="text-gray-500 text-lg">لا توجد مجموعات للعرض</span>
            <p class="text-gray-400 text-sm max-w-md">لم يتم العثور على مجموعات مطابقة لمعايير البحث. يرجى تعديل المعايير أو إضافة مجموعات جديدة.</p>
            <button pButton icon="pi pi-plus" label="إضافة مجموعة جديدة" 
                    (click)="showAddGroupForm()"
                    class="p-button-primary bg-emerald-600 hover:bg-emerald-700 border-emerald-600 mt-2"></button>
          </div>
        </div>
      </div>
    </div>


    
  </div>
</div>

<!-- Add Group Dialog -->
<p-dialog header="إضافة مجموعة جديدة" [(visible)]="showAddForm" [modal]="true" 
          styleClass="w-full max-w-4xl shadow-xl" [dir]="'rtl'">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-5 p-6 bg-gray-50 rounded-lg">
    
    <!-- Group Name -->
    <div class="field">
      <label for="groupName" class="block text-sm font-semibold text-gray-800 mb-2">اسم المجموعة *</label>
      <input pInputText id="groupName" [(ngModel)]="groupForm.groupName" 
             class="w-full p-3 rounded-lg border-2 border-gray-200" 
             placeholder="أدخل اسم المجموعة" />
    </div>

    <!-- Start Date -->
    <!-- <div class="field">
      <label for="startDate" class="block text-sm font-semibold text-gray-800 mb-2">تاريخ البداية *</label>
      <p-calendar id="startDate" [(ngModel)]="groupForm.startDate" 
                  [showIcon]="true" dateFormat="yy-mm-dd" [showButtonBar]="true"
                  inputStyleClass="w-full p-3 rounded-lg border-2 border-gray-200"
                  placeholder="اختر التاريخ"
                  styleClass="w-full"></p-calendar>
    </div> -->


   <!-- <p-dropdown [options]="teacher" [(ngModel)]="groupForm.teacherId"
            optionLabel="name" optionValue="id"
            [showClear]="true" [filter]="true" filterBy="name"
            placeholder="اختر المعلم" onfocus="loadTeachers()" onclick="loadTeachers()"
            styleClass="w-full border-2 border-gray-200"> -->
            <p-dropdown [options]="teacher" [(ngModel)]="groupForm.teacherId"
            optionLabel="name" optionValue="id"
            [showClear]="true" [filter]="true" filterBy="name"
            placeholder="اختر المعلم"
            styleClass="w-full border-2 border-gray-200">
  
  <ng-template pTemplate="loading" *ngIf="loading">
    <div class="p-2 text-center">جاري تحميل البيانات...</div>
  </ng-template>
  
  <ng-template let-teacher pTemplate="item">
    <div class="flex items-center gap-2">
      <i class="pi pi-user"></i>
      <span>{{ teacher.name }}</span>
    </div>
  </ng-template>
</p-dropdown>
  
    <!-- Max Capacity -->
    <div class="field">
      <label for="maxCapacity" class="block text-sm font-semibold text-gray-800 mb-2">السعة القصوى *</label>
      <p-inputNumber id="maxCapacity" [(ngModel)]="groupForm.maxCapacity" 
                     [min]="1" [max]="100" [showButtons]="true"
                     inputStyleClass="w-full p-3 rounded-lg border-2 border-gray-200"
                     styleClass="w-full"></p-inputNumber>
    </div>

    <!-- Schedule Days -->
    <div class="field">
      <label for="scheduleDays" class="block text-sm font-semibold text-gray-800 mb-2">أيام الجدول *</label>
      <p-multiSelect id="scheduleDays" [options]="scheduleDayOptions" [(ngModel)]="groupForm.scheduleDays"
                     optionLabel="label" [optionValue]="'value'" [filter]="false"
                     defaultLabel="اختر الأيام" display="chip"
                     panelStyleClass="z-50 shadow-lg"
                     styleClass="w-full border-2 border-gray-200"></p-multiSelect>
    </div>

    <!-- Education Stage -->
    <div class="field">
      <label for="educationStage" class="block text-sm font-semibold text-gray-800 mb-2">المرحلة التعليمية *</label>
      <p-dropdown id="educationStage" [options]="educationStageOptions" [(ngModel)]="groupForm.educationStage" 
                  optionLabel="label" optionValue="value" [filter]="false"
                  panelStyleClass="z-50 shadow-lg"
                  styleClass="w-full border-2 border-gray-200"
                  placeholder="اختر المرحلة"></p-dropdown>
    </div>

    <!-- Start Time -->
    <!-- <div class="field">
      <label for="startTime" class="block text-sm font-semibold text-gray-800 mb-2">وقت البداية *</label>
      <input pInputText id="startTime" [(ngModel)]="groupForm.startTime" 
             class="w-full p-3 rounded-lg border-2 border-gray-200" 
             placeholder="مثال: 09:00 ص" />
    </div> -->

    <!-- Grade Level -->
    <div class="field">
      <label for="gradeLevel" class="block text-sm font-semibold text-gray-800 mb-2">الصف *</label>
      <p-dropdown id="gradeLevel" [options]="gradeLevels" [(ngModel)]="groupForm.gradeLevel" 
                  optionLabel="label" optionValue="value" [filter]="false"
                  panelStyleClass="z-50 shadow-lg"
                  styleClass="w-full border-2 border-gray-200"
                  placeholder="اختر الصف"></p-dropdown>
    </div>

  </div>

  <div class="flex justify-end gap-4 p-5 border-t border-gray-200 bg-white rounded-b-lg">
    <button pButton label="إلغاء" (click)="hideAddForm()"
            class="p-button-text text-gray-600 hover:bg-gray-100 px-5 py-2 rounded-lg border border-gray-300"></button>
    <button pButton label="حفظ" (click)="submitAddForm()"
            class="bg-blue-600 hover:bg-blue-700 border-blue-600 text-white px-5 py-2 rounded-lg"></button>
  </div>
</p-dialog>


<!-- Edit Group Dialog -->
<p-dialog header="تعديل المجموعة" [(visible)]="showEditForm" [modal]="true" 
          [closable]="true" [draggable]="false" [resizable]="false"
          styleClass="w-full max-w-4xl" [dir]="'rtl'">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Group Name -->
    <div class="field">
      <label for="editGroupName" class="block text-sm font-medium text-gray-700 mb-2">اسم المجموعة *</label>
      <input pInputText id="editGroupName" [(ngModel)]="groupForm.groupName" 
             class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring focus:ring-emerald-200" 
             placeholder="أدخل اسم المجموعة" />
    </div>

    <!-- Description -->
    <div class="field">
      <label for="editDescription" class="block text-sm font-medium text-gray-700 mb-2">الوصف *</label>
      <textarea pInputTextarea id="editDescription" [(ngModel)]="groupForm.description" rows="3"
                class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring focus:ring-emerald-200" 
                placeholder="أدخل وصف المجموعة"></textarea>
    </div>

    <!-- Max Capacity -->
    <div class="field">
      <label for="editMaxCapacity" class="block text-sm font-medium text-gray-700 mb-2">السعة القصوى *</label>
      <p-inputNumber id="editMaxCapacity" [(ngModel)]="groupForm.maxCapacity" 
                     [min]="1" [max]="100" [showButtons]="true"
                     styleClass="w-full" inputStyleClass="w-full rounded-lg"></p-inputNumber>
    </div>

    <!-- Start Date -->
    <div class="field">
      <label for="editStartDate" class="block text-sm font-medium text-gray-700 mb-2">تاريخ البداية *</label>
      <p-calendar id="editStartDate" [(ngModel)]="groupForm.startDate" 
                  [showIcon]="true" dateFormat="yy-mm-dd"
                  styleClass="w-full" inputStyleClass="w-full rounded-lg"></p-calendar>
    </div>

    <!-- Schedule Day -->
    <div class="field">
      <label for="editScheduleDay" class="block text-sm font-medium text-gray-700 mb-2">يوم الجدول *</label>
      <p-dropdown id="editScheduleDay" [options]="scheduleOptions" [(ngModel)]="groupForm.scheduleDay" 
                  optionLabel="label" optionValue="value" 
                  styleClass="w-full" placeholder="اختر يوم"></p-dropdown>
    </div>

    <!-- Start Time -->
    <div class="field">
      <label for="editStartTime" class="block text-sm font-medium text-gray-700 mb-2">وقت البداية *</label>
      <input pInputText id="editStartTime" [(ngModel)]="groupForm.startTime" 
             class="w-full rounded-lg border-gray-300 focus:border-emerald-500 focus:ring focus:ring-emerald-200" 
             placeholder="مثال: 09:00 AM" />
    </div>

    <!-- Education Stage -->
    <div class="field">
      <label for="editEducationStage" class="block text-sm font-medium text-gray-700 mb-2">المرحلة التعليمية *</label>
      <p-dropdown id="editEducationStage" [options]="educationStageOptions" [(ngModel)]="groupForm.educationStage" 
                  optionLabel="label" optionValue="value" 
                  styleClass="w-full" placeholder="اختر المرحلة"></p-dropdown>
    </div>

    <!-- Grade Level -->
    <div class="field">
      <label for="editGradeLevel" class="block text-sm font-medium text-gray-700 mb-2">الصف *</label>
      <p-dropdown id="editGradeLevel" [options]="gradeLevels" [(ngModel)]="groupForm.gradeLevel" 
                  optionLabel="label" optionValue="value" 
                  styleClass="w-full" placeholder="اختر الصف"></p-dropdown>
    </div>
  </div>

  <div class="flex justify-end gap-3 mt-6">
    <button pButton label="إلغاء" icon="pi pi-times" 
            (click)="hideEditForm()"
            class="p-button-text text-gray-600"></button>
    <button pButton label="حفظ التغييرات" icon="pi pi-check" 
            (click)="submitEditForm()"
            class="p-button-primary bg-emerald-600 hover:bg-emerald-700 border-emerald-600"></button>
  </div>
</p-dialog>

<!-- Toast Messages -->
<p-toast position="top-right" [dir]="'rtl'"></p-toast>